function MilkCocoa(t,e){this.host=format_host(t),this.milfeeSocket=new MilfeeSocket(this.host,e)}function DataStore(t,e){this.milfeeSocket=t,this.path=pathutil.norm(e),this.data=null}function Query(t,e){this.milfeeSocket=t,this.params=e,this.params.option={}}function MilfeeSocket(t,e){var n=this;this.app_id=t.split(".")[0],this.callback_id=0,this.callbacks={},this.listeners={push:{},set:{},remove:{},send:{}},this.host=t,this.socket=client.connect(t,{reconnect:!0,"reconnection delay":500,"max reconnection attempts":10,"force new connection":!0,transport:"websocket"}),this.reconnect_count=0,this.queue=[],this.mode="offline",this.idGenerator=new IdGenerator,this.socket.on("connect",function(){console.log("connected"),n.reconnect_count++,n.reconnect_count<=1&&e&&e(),n.socket.on("init",function(t){n.idGenerator.init(t.ts),n.fire_operations()}),n.socket.on(eventnames.callback,function(t){var e="a"+String(t.callback_id);n.callbacks[e]&&n.callbacks[e](t.docs)}),n.socket.on(eventnames.push,function(t){for(var e=0;e<n.listeners.push[t.sys.path].length;e++)n.listeners.push[t.sys.path][e](t)}),n.socket.on(eventnames.set,function(t){for(var e=0;e<n.listeners.set[t.sys.path].length;e++)n.listeners.set[t.sys.path][e](t)}),n.socket.on(eventnames.remove,function(t){for(var e=0;e<n.listeners.remove[t.sys.path].length;e++)n.listeners.remove[t.sys.path][e](t)}),n.socket.on(eventnames.send,function(t){for(var e=0;e<n.listeners.send[t.sys.path].length;e++)n.listeners.send[t.sys.path][e](t)})})}function IdGenerator(){this.timestamp=(new Date).getTime(),this.id_header=this.getHeader(this.timestamp),this.prev_id=0}function format_host(t){return"/"===t[t.length-1]?t:t+"/"}function do_ajax(t,e,n,o){function i(t){var e=[];for(var n in t)e.push(n+"="+encodeURIComponent(t[n]));return e.join("&")}var s=null;window.XMLHttpRequest?s=new XMLHttpRequest:window.XDomainRequest&&(s=new XDomainRequest),s.open(t,e),s.withCredentials=!0,s.onload=function(){o(JSON.parse(s.responseText))};var a=i(n);s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.send(a)}var client=require("socket.io-client");module.exports=MilkCocoa;var eventnames={callback:"a",push:"b",set:"c",remove:"d",send:"e"};MilkCocoa.prototype={auth:function(t,e){var n=this,o={token:t};do_ajax("POST",n.host+"account-api/auth",o,function(t){milfeeSocket.disconnect(),milfeeSocket=new MilfeeSocket(n.host,function(){e(t.err,t.user)})})},addAccount:function(t,e,n,o){var i={email:t,secret:e,option:n};milfeeSocket.send_and_callback("signup",i,function(t){o(t.err,t.user)})},login:function(t,e,n){var o=this,i={email:t,secret:e};do_ajax("POST",o.host+"account-api/login",i,function(t){t.user?(milfeeSocket.disconnect(),milfeeSocket=new MilfeeSocket(o.host,function(){n(t.err,t.user)})):n(t.err,t.user)})},anonymous:function(t){var e=this;do_ajax("POST",e.host+"account-api/anonymous",{},function(n){milfeeSocket.disconnect(),milfeeSocket=new MilfeeSocket(e.host,function(){t(n.err,n.user)})})},logout:function(t){var e=this,n={};do_ajax("POST",e.host+"account-api/logout",n,function(n){milfeeSocket.disconnect(),milfeeSocket=new MilfeeSocket(e.host,function(){t&&t(n.err)})})},getCurrentUser:function(t){milfeeSocket.send_and_callback("getcurrentuser",{},function(e){t(e.err,e.user)})},dataStore:function(t){return new DataStore(this.milfeeSocket,t)}},DataStore.prototype={send:function(t,e){var n={path:this.path,value:t};this.milfeeSocket.send_and_callback("send",n,e)},off:function(t){milfeeSocket.off(t,this.path);var e={path:this.path,event:t};this.milfeeSocket.send("off",e)},on:function(t,e){this.milfeeSocket.on(t,this.path,e)},push:function(t,e){var n=this.milfeeSocket.idGenerator.getNextId(),o={path:this.path,value:t,id:n};return this.milfeeSocket.send_and_callback("push",o,e),new DataStore(this.milfeeSocket,pathutil.norm(this.path+"/"+n))},remove:function(t,e){var n={path:this.path+"/"+t};this.milfeeSocket.send_and_callback("unset",n,e)},set:function(t,e,n){var o={path:this.path+"/"+t,value:e};this.milfeeSocket.send_and_callback("set",o,n)},query:function(t){var e={path:this.path,query:t};return new Query(this.milfeeSocket,e)},get:function(t){var e={path:this.path};this.milfeeSocket.send_and_callback("get",e,function(e){t(e)})},getPath:function(){return this.path},parent:function(){return new DataStore(this.milfeeSocket,pathutil.parent(this.path))},child:function(t){return new DataStore(this.milfeeSocket,pathutil.norm(this.path+"/"+t))},root:function(){return new DataStore(this.milfeeSocket,"/")}},Query.prototype={done:function(t){this.milfeeSocket.send_and_callback("fm",this.params,function(e){t(e)})},skip:function(t){return"number"!=typeof t&&console.warn("invalid skip parameter."),this.params.option.skip=t,this},sort:function(t){var e=t||"desc";return"asc"==e?this.params.option.sort="$natural":"desc"==e?this.params.option.desc="$natural":(console.warn("undefined sort mode."),console.log('usage : sort("desc")')),this},asc:function(){return this.sort("asc")},desc:function(){return this.sort("desc")},desort:function(t){return this.params.option.desc=t,this},limit:function(t){return this.params.option.limit=t,this}},MilfeeSocket.prototype.disconnect=function(){this.socket&&this.socket.disconnect()},MilfeeSocket.prototype.getAppID=function(){return this.app_id},MilfeeSocket.prototype.online=function(){"offline"==this.mode},MilfeeSocket.prototype.offline=function(){"online"==this.mode&&this.fire_operations()},MilfeeSocket.prototype.fire_operations=function(){for(var t=this,e=0;e<t.queue.length;e++)"s"==t.queue[e].method?t.send(t.queue[e].event,t.queue[e].packet):"sac"==t.queue[e].method&&t.send_and_callback(t.queue[e].event,t.queue[e].packet,t.queue[e].cb);t.queue=[]},MilfeeSocket.prototype.reset_on=function(){var t=this;for(var e in this.listeners)for(var n in this.listeners[e])this.listeners[e][n].forEach(function(o){t.on(e,n,o)})},MilfeeSocket.prototype.on=function(t,e,n){this.listeners[t].hasOwnProperty(e)||(this.listeners[t][e]=[]),this.listeners[t][e].push(n);var o={event:t,path:e};this.send("on",o)},MilfeeSocket.prototype.off=function(t,e){this.listeners[t][e]=[]},MilfeeSocket.prototype.send=function(t,e){return 0==this.reconnect_count?void this.queue.push({method:"s",event:t,packet:e}):void this.socket.emit(t,e)},MilfeeSocket.prototype.send_and_callback=function(t,e,n){return 0==this.reconnect_count?void this.queue.push({method:"sac",event:t,packet:e,cb:n}):(e.callback_id=this.callback_id,this.callbacks["a"+String(this.callback_id)]=n,this.socket.emit(t,e),void this.callback_id++)};var pathutil={norm:function(t){for(var e=t.split("/"),n=[],o=0;o<e.length;o++)""!=e[o]&&n.push(e[o]);return n.join("/")},parent:function(t){var e=t.split("/");return e.pop(),e.join("/")}},shuffle_table="ybfghijam6cpqdrw71nx34eo5suz0t9vkl28";IdGenerator.prototype={init:function(t){this.timestamp=t,this.id_header=this.getHeader(this.timestamp)},getHeader:function(t){return t.toString(36)},getHash:function(t){for(var e="",n=t;n>0;)e+=shuffle_table[n%36],n/=36,n=Math.floor(n);return e},getNextId:function(){function t(t){for(var e=t,n=0;n<4-t.length;n++)e="0"+e;return e}return this.prev_id++,this.id_header+t(this.prev_id.toString(36))+shuffle_table[Math.floor(36*Math.random())]+shuffle_table[Math.floor(36*Math.random())]+shuffle_table[Math.floor(36*Math.random())]}};